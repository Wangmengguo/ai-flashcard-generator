<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Flashcard 生成器</title>
    <style>
        /* 基础样式 */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }

        /* 输入区域样式 */
        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2c3e50;
        }

        input[type="password"],
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
        }

        textarea {
            min-height: 200px;
            resize: vertical;
        }

        /* 按钮样式 */
        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #generateButton {
            background-color: #2ecc71;
            color: white;
            flex: 1;
        }

        #generateButton:hover {
            background-color: #27ae60;
        }

        #copyButton {
            background-color: #3498db;
            color: white;
            display: none;
        }

        #copyButton:hover {
            background-color: #2980b9;
        }

        #clearButton {
            background-color: #e74c3c;
            color: white;
        }

        #clearButton:hover {
            background-color: #c0392b;
        }

        /* 消息和结果样式 */
        .message {
            padding: 12px;
            margin-bottom: 20px;
            border-radius: 6px;
            display: none;
        }

        .error {
            background-color: #fee2e2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .success {
            background-color: #dcfce7;
            color: #16a34a;
            border: 1px solid #bbf7d0;
        }

        .loading {
            background-color: #f3f4f6;
            color: #4b5563;
            border: 1px solid #e5e7eb;
            gap: 10px;
        }
        
        .loading.show {
        display: flex !important;
        align-items: center;
        justify-content: center;
        }

        /* Flashcard 样式改进 */
        .flashcard {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); /* 添加轻微阴影提升层次感 */
            position: relative; /* 为了放置删除按钮 */
            transition: box-shadow 0.3s, transform 0.3s; /* 添加过渡效果 */
        }

        /* 卡片悬停效果 */
        .flashcard:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transform: translateY(-2px); /* 轻微上浮效果 */
        }

        .flashcard .question {
            font-weight: 600;
            color: #1e40af; /* 深蓝色问题 */
            margin-bottom: 12px; /* 增加与答案的间距 */
            font-size: 1.05em; /* 问题字体稍大 */
            padding-right: 30px; /* 为删除按钮留出空间 */
        }

        .flashcard .answer {
            color: #334155; /* 深灰色答案 */
            line-height: 1.5; /* 增加行高提高可读性 */
            padding-top: 8px; /* 增加上内边距 */
            border-top: 1px solid #f0f0f0; /* 添加轻微分隔线 */
        }

        /* 删除按钮样式 */
        .delete-btn {
            position: absolute;
            right: 12px;
            top: 12px;
            width: 28px;  /* 确保宽高相等 */
            height: 28px;
            background-color: #f8f9fa; /* 浅灰色背景 */
            color: #6c757d; /* 灰色图标 - 未激活状态 */
            border-radius: 50%; /* 确保是圆形 */
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            border: 1px solid #e9ecef; /* 淡色边框增加立体感 */
            transition: all 0.2s;
            opacity: 0.7;
            padding: 0; /* 移除默认padding */
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); /* 轻微阴影 */
        }

        /* 删除按钮悬停效果 */
        .delete-btn:hover {
            opacity: 1;
            background-color: #f8d7da; /* 淡红色背景 */
            color: #dc3545; /* 红色图标 */
            border-color: #f5c2c7; /* 红色边框 */
        }

        /* 确认状态样式单独定义 */
        .delete-btn.confirming {
            width: 52px !important; /* 确保宽度统一 */
            border-radius: 15px !important; /* 圆角矩形 */
            background-color: #dc3545 !important;
            color: white !important;
            font-size: 13px !important; /* 字体稍小 */
            opacity: 1 !important;
        }

        /* 加载动画 */
        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>AI Flashcard 生成器</h1>
        
        <!-- 输入区域 -->
        <div class="input-group">
            <label for="apiKey">OpenRouter API 密钥:</label>
            <input type="password" id="apiKey" placeholder="输入你的 OpenRouter API 密钥">
        </div>

        <div class="input-group">
            <label for="inputText">输入文本:</label>
            <textarea id="inputText" placeholder="在此粘贴需要生成 Flashcard 的文本..."></textarea>
        </div>

        <!-- 按钮区域 -->
        <div class="button-group">
            <button id="generateButton" onclick="generateFlashcards()">生成 Flashcards</button>
            <button id="copyButton" onclick="copyToAnki()">复制为 Anki 格式</button>
            <button id="clearButton" onclick="clearInputs()">清除输入</button>
        </div>

        <!-- 消息区域 -->
        <div id="errorMessage" class="message error"></div>
        <div id="successMessage" class="message success"></div>
        <div id="loadingMessage" class="message loading">
            <span class="spinner"></span>
            <span>正在生成 Flashcards，请稍候...</span>
        </div>

        <!-- 结果区域 -->
        <div id="results"></div>
    </div>

    <script>
        // 保存和加载 API 密钥
        const apiKeyInput = document.getElementById('apiKey');
        if (localStorage.getItem('openRouterApiKey')) {
            apiKeyInput.value = localStorage.getItem('openRouterApiKey');
        }
        apiKeyInput.addEventListener('input', () => {
            localStorage.setItem('openRouterApiKey', apiKeyInput.value);
        });

        // 显示消息的辅助函数
        function showMessage(type, messageText) {
            const errorEl = document.getElementById('errorMessage');
            const successEl = document.getElementById('successMessage');
            const loadingEl = document.getElementById('loadingMessage');

            // 首先隐藏所有
            errorEl.style.display = 'none';
            successEl.style.display = 'none';
            loadingEl.classList.remove('show'); // 直接移除 show 类

            if (type === 'loading') {
                loadingEl.classList.add('show');
            } else if (type === 'error' && messageText) {
                errorEl.textContent = messageText;
                errorEl.style.display = 'block';
            } else if (type === 'success' && messageText) {
                successEl.textContent = messageText;
                successEl.style.display = 'block';
            }
        }
        
        // 生成 Flashcards
        async function generateFlashcards() {
            const apiKey = apiKeyInput.value.trim();
            const text = document.getElementById('inputText').value.trim();
            const resultsDiv = document.getElementById('results');
            const copyButton = document.getElementById('copyButton');

            // 输入验证
            if (!apiKey) {
                showMessage('error', '请输入 OpenRouter API 密钥');
                return;
            }
            if (!text) {
                showMessage('error', '请输入要处理的文本');
                return;
            }

            // API密钥格式验证
            if (!validateApiKey(apiKey)) {
                showMessage('error', '无效的 API 密钥');
                return;
            }

            // 输入长度验证
            const inputValidation = validateInputLength(text);
            if (!inputValidation.valid) {
                showMessage('error', inputValidation.warning);
                return;
            }

            // 准备生成
            showMessage('loading');
            resultsDiv.innerHTML = '';
            copyButton.style.display = 'none';

            try {
                const response = await fetch('http://127.0.0.1:8000/generate_flashcards/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        text: text,
                        api_key: apiKey
                    })
                });

                const data = await response.json();
                
                // 打印data
                console.log('data.detail:', data.detail);

                if (!response.ok) {
                    // data.detail 可能是字符串，也可能是对象
                    let errorMsg = '';
                    if (data && typeof data.detail === 'object' && data.detail.message) {
                        errorMsg = data.detail.message;
                    } else if (data && typeof data.detail === 'string') {
                        errorMsg = data.detail;
                    } else {
                        errorMsg = '生成 Flashcards 时发生未知错误';
                    }
                    throw new Error(errorMsg);
                }

                if (data.error) {
                    throw new Error(data.error);
                }

                // 显示结果
                if (data.flashcards && data.flashcards.length > 0) {
                    data.flashcards.forEach(card => {
                        const cardElement = document.createElement('div');
                        cardElement.className = 'flashcard';
                        
                        // 创建删除按钮
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'delete-btn';
                        deleteBtn.innerHTML = '×'; 
                        deleteBtn.title = '删除';
                        deleteBtn.onclick = function(e) {
                            e.stopPropagation(); // 防止事件冒泡
                            
                            // 已经处于确认状态
                            if (deleteBtn.classList.contains('confirming')) {
                                cardElement.style.height = '0';
                                cardElement.style.opacity = '0';
                                cardElement.style.margin = '0';
                                cardElement.style.padding = '0';
                                cardElement.style.overflow = 'hidden';
                                
                                // 300ms后彻底移除元素
                                setTimeout(() => {
                                    cardElement.remove();
                                    
                                    // 检查是否还有卡片
                                    const remainingCards = document.getElementsByClassName('flashcard');
                                    if (remainingCards.length === 0) {
                                        copyButton.style.display = 'none';
                                        showMessage('error', '已删除所有卡片');
                                    }
                                }, 300);
                            } else {
                                // 进入确认状态
                                deleteBtn.classList.add('confirming');
                                deleteBtn.innerHTML = '确认';
                                
                                // 3秒后如果没确认，恢复原状
                                setTimeout(() => {
                                    if (deleteBtn.classList.contains('confirming')) {
                                        deleteBtn.classList.remove('confirming');
                                        deleteBtn.innerHTML = '×';
                                    }
                                }, 3000);
                            }
                        };
                        
                        // 创建问题和答案元素
                        const questionElement = document.createElement('div');
                        questionElement.className = 'question';
                        questionElement.textContent = 'Q: ' + card.q;
                        
                        const answerElement = document.createElement('div');
                        answerElement.className = 'answer';
                        answerElement.textContent = 'A: ' + card.a;
                        
                        // 将元素添加到卡片
                        cardElement.appendChild(deleteBtn);
                        cardElement.appendChild(questionElement);
                        cardElement.appendChild(answerElement);
                        
                        // 将卡片添加到结果区域
                        resultsDiv.appendChild(cardElement);
                    });

                    copyButton.style.display = 'block';
                    showMessage('success', `成功生成 ${data.flashcards.length} 个 Flashcards！`);
                } else {
                    showMessage('error', '未能生成任何 Flashcards');
                }

            } catch (error) {
                showMessage('error', error.message);
                console.error('Error:', error);
            }
        }

        // 复制为 Anki 格式
        async function copyToAnki() {
            const flashcards = document.getElementsByClassName('flashcard');
            if (flashcards.length === 0) {
                showMessage('error', '没有可复制的 Flashcards');
                return;
            }

            let ankiText = '';
            Array.from(flashcards).forEach(card => {
                // 注意这里，因为结构改变，需要获取文本内容并去掉"Q: "和"A: "前缀
                const question = card.querySelector('.question').textContent.replace('Q: ', '').trim();
                const answer = card.querySelector('.answer').textContent.replace('A: ', '').trim();
                ankiText += `${question}\t${answer}\n`;
            });

            try {
                await navigator.clipboard.writeText(ankiText.trim());
                showMessage('success', '已复制到剪贴板！');
            } catch (err) {
                showMessage('error', '复制失败: ' + err.message);
                console.error('复制失败:', err);
            }
        }

        // HTML 转义函数
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // 验证 API 密钥
        function validateApiKey(apiKey) {
            return apiKey && /^sk-or-.+/.test(apiKey.trim());
        }

        // 验证输入长度
        function validateInputLength(text, min=20, max=4000) {
            if (text.length < min) return {valid: false, warning: "输入内容过短，建议添加更多上下文。"};
            if (text.length > max) return {valid: false, warning: "输入内容过长，可能超出LLM处理能力。"};
            return {valid: true};
        }

        // 清除输入框
        function clearInputs() {
            document.getElementById('inputText').value = '';
            // API密钥通常不需要清除，因为用户可能希望保留它
            // 但如果需要同时清除API密钥，取消下面这行的注释
            // document.getElementById('apiKey').value = '';
            
            // 清除结果区域
            document.getElementById('results').innerHTML = '';
            
            // 隐藏复制按钮
            document.getElementById('copyButton').style.display = 'none';
            
            // 清除所有提示消息
            showMessage('', '');
        }
    </script>
</body>
</html>