# 🔧 自定义Prompt字符串格式化错误修复

## 问题报告
**发现时间**: 2025-06-20 23:50  
**错误信息**: `Error: 'max_cards'`  
**触发条件**: 使用自定义Prompt模板时  
**错误位置**: `unified_index.html:1429`

## 问题分析

### 错误原因
在之前的修复中，我们在JavaScript字符串模板中使用了错误的占位符语法：

```javascript
// ❌ 错误：使用了{max_cards}占位符但没有处理
const systemPrompt = `...生成不超过{max_cards}张高质量卡片...`;
custom_user_prompt: "请为以下文本生成Flashcards（最多{max_cards}张）：\n\n{text}"
```

### 问题根源
1. **占位符冲突**: `{max_cards}`是为后端模板系统设计的占位符
2. **前端未处理**: 前端直接发送包含未处理占位符的字符串
3. **后端格式化失败**: 后端尝试格式化时找不到`max_cards`变量

## 修复方案

### 1. ✅ 修复systemPrompt占位符
```javascript
// 修复前（有问题）
const systemPrompt = `...生成不超过{max_cards}张高质量卡片...`;

// 修复后（正确）
const systemPrompt = `...生成不超过${cardCount}张高质量卡片...`;
```

**说明**: 使用JavaScript模板字符串语法`${cardCount}`直接插值实际数值。

### 2. ✅ 修复custom_user_prompt占位符
```javascript
// 修复前（有问题）
custom_user_prompt: "请为以下文本生成Flashcards（最多{max_cards}张）：\n\n{text}"

// 修复后（正确）
custom_user_prompt: `请为以下文本生成Flashcards（最多${cardCount}张）：\n\n{text}`
```

**说明**: 
- 使用模板字符串语法替换`{max_cards}`为实际数值
- 保留`{text}`占位符，因为后端需要这个占位符

## 技术细节

### JavaScript模板字符串 vs 后端模板占位符

| 类型 | 语法 | 处理位置 | 示例 |
|------|------|----------|------|
| JavaScript模板字符串 | `${variable}` | 前端 | `生成${cardCount}张卡片` |
| 后端模板占位符 | `{variable}` | 后端 | `处理以下文本：{text}` |

### 占位符处理策略
1. **前端处理**: 使用`${cardCount}`在前端直接替换数值
2. **后端处理**: 保留`{text}`让后端模板系统处理
3. **避免冲突**: 不在同一字符串中混用两种语法

## 修复验证

### 修复前错误
```javascript
// 发送到后端的数据包含未处理占位符
{
  custom_system_prompt: "...生成不超过{max_cards}张...",  // ❌ 未处理
  custom_user_prompt: "...（最多{max_cards}张）..."     // ❌ 未处理
}
```

### 修复后正确
```javascript
// 发送到后端的数据包含实际数值
{
  custom_system_prompt: "...生成不超过15张...",         // ✅ 已处理
  custom_user_prompt: "...（最多15张）..."             // ✅ 已处理
}
```

## 功能测试

### 测试用例1: 空白自定义Prompt
- **操作**: 选择自定义模板，不输入任何内容
- **预期**: 使用默认模板，包含正确的卡片数量
- **结果**: ✅ 正常工作

### 测试用例2: 自定义Prompt内容
- **操作**: 选择自定义模板，输入自定义内容
- **预期**: 使用用户输入的内容生成卡片
- **结果**: ✅ 正常工作

### 测试用例3: 不同卡片数量
- **操作**: 调整卡片数量滑块，使用自定义模板
- **预期**: 生成对应数量的卡片
- **结果**: ✅ 数量正确

## 经验总结

### 避免类似问题的最佳实践

1. **明确占位符归属**
   - 前端使用: `${variable}` (JavaScript模板字符串)
   - 后端使用: `{variable}` (服务器模板系统)

2. **分层处理原则**
   - 前端负责: 用户界面相关的动态值
   - 后端负责: 业务逻辑相关的模板处理

3. **字符串处理策略**
   - 在数据发送前完成所有前端占位符替换
   - 只发送后端需要的占位符到服务器

4. **测试覆盖**
   - 测试各种模板组合
   - 验证占位符正确处理
   - 确保错误信息清晰

## 性能影响

### 修复前后对比
- **内存使用**: 无变化
- **网络传输**: 轻微减少（移除无效占位符）
- **服务器处理**: 提升（避免格式化错误）
- **用户体验**: 显著提升（功能正常工作）

## 后续优化建议

### 短期优化
1. **错误处理增强**: 提供更明确的错误信息
2. **占位符验证**: 前端验证模板字符串格式
3. **用户指导**: 在帮助文档中说明占位符使用

### 中期规划
1. **模板预览**: 实时预览处理后的模板内容
2. **智能提示**: 自动补全常用模板片段
3. **模板验证**: 前端验证模板语法正确性

---

**修复执行者**: Claude Code  
**问题发现者**: 用户测试  
**修复状态**: ✅ 完成并验证  
**影响评估**: 自定义Prompt功能完全恢复正常